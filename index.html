<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ThamAI Assistant</title>
  <style>
    /* ====== Giao di·ªán ch√≠nh ====== */
    body {
      font-family: "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #eef2f3, #dfe6e9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      margin: 0;
    }

    h1 {
      color: #2c3e50;
      margin-bottom: 10px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    #chat-container {
      width: 400px;
      max-width: 90%;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 16px;
      display: flex;
      flex-direction: column;
      height: 70vh;
    }

    /* ====== Khu chat ====== */
    #chat-box {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      border-radius: 8px;
      background: #f7f9fa;
      margin-bottom: 10px;
      scroll-behavior: smooth;
    }

    .message {
      margin: 6px 0;
      padding: 8px 12px;
      border-radius: 12px;
      max-width: 80%;
      line-height: 1.4;
      word-wrap: break-word;
    }

    .user {
      background: #d1f7d1;
      align-self: flex-end;
      border-top-right-radius: 0;
    }

    .bot {
      background: #e0ecff;
      align-self: flex-start;
      border-top-left-radius: 0;
    }

    /* ====== Thanh nh·∫≠p ====== */
    #input-container {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    input {
      flex: 1;
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
    }

    button {
      padding: 8px 12px;
      border: none;
      border-radius: 8px;
      background: #3498db;
      color: white;
      cursor: pointer;
      transition: 0.2s;
    }

    button:hover {
      background: #2980b9;
    }

    /* ====== Menu ch·ªçn gi·ªçng, t·ªëc ƒë·ªô, c·∫£m x√∫c ====== */
    #voice-options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 14px;
    }

    #voice-options select {
      padding: 4px;
      border-radius: 6px;
      border: 1px solid #ccc;
      outline: none;
    }

    /* ====== Tr·∫°ng th√°i n√≥i ====== */
    #status {
      margin-top: 4px;
      font-size: 14px;
      color: #555;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    #speaker-icon {
      display: none;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 0.5; }
      50% { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 0.5; }
    }

    /* ====== Thanh cu·ªôn g·ªçn ƒë·∫πp ====== */
    #chat-box::-webkit-scrollbar { width: 6px; }
    #chat-box::-webkit-scrollbar-thumb {
      background-color: rgba(0,0,0,0.2);
      border-radius: 3px;
    }
    #chat-box::-webkit-scrollbar-thumb:hover {
      background-color: rgba(0,0,0,0.3);
    }
  </style>
</head>

<body>
  <h1>ü§ñ Tr·ª£ l√Ω ThamAI</h1>
  <div id="chat-container">
    <div id="voice-options">
      <label>Gi·ªçng:
        <select id="voice-select"></select>
      </label>
      <label>T·ªëc ƒë·ªô:
        <select id="speed-select">
          <option value="slow">Ch·∫≠m</option>
          <option value="normal" selected>V·ª´a</option>
          <option value="fast">Nhanh</option>
        </select>
      </label>
      <label>C·∫£m x√∫c:
        <select id="emotion-select">
          <option value="auto" selected>T·ª± ƒë·ªông</option>
          <option value="vui">Vui</option>
          <option value="nghi√™m">Nghi√™m</option>
          <option value="nh·∫π">Nh·∫π nh√†ng</option>
        </select>
      </label>
    </div>

    <div id="chat-box"></div>

    <div id="input-container">
      <input type="text" id="user-input" placeholder="Nh·∫≠p n·ªôi dung..." />
      <button id="send-btn">üì® G·ª≠i</button>
      <button id="record-btn">üé§ Ghi √¢m</button>
    </div>

    <div id="status">
      <span id="speaker-icon">üîä</span>
      <span id="status-text"></span>
    </div>
  </div>

  <script>
    const BACKEND_URL = "https://thamai-backend-new.onrender.com";

    const chatBox = document.getElementById("chat-box");
    const userInput = document.getElementById("user-input");
    const sendBtn = document.getElementById("send-btn");
    const recordBtn = document.getElementById("record-btn");
    const voiceSelect = document.getElementById("voice-select");
    const speedSelect = document.getElementById("speed-select");
    const emotionSelect = document.getElementById("emotion-select");
    const statusText = document.getElementById("status-text");
    const speakerIcon = document.getElementById("speaker-icon");

    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];
    let isSpeaking = false;
    let silenceTimer;

    function addMessage(sender, text) {
      const msg = document.createElement("div");
      msg.classList.add("message", sender);
      msg.textContent = text;
      chatBox.appendChild(msg);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function sendMessage() {
      const message = userInput.value.trim();
      if (!message) return;

      addMessage("user", message);
      userInput.value = "";

      const res = await fetch(`${BACKEND_URL}/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message })
      });

      const data = await res.json();
      const reply = data.reply || "‚ùå L·ªói ph·∫£n h·ªìi.";
      addMessage("bot", reply);
      speakText(reply);
    }

    userInput.addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });
    sendBtn.addEventListener("click", sendMessage);

    recordBtn.addEventListener("click", async () => {
      if (isRecording) stopRecording();
      else startRecording();
    });

    async function startRecording() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];
        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
        mediaRecorder.onstop = sendAudioToBackend;
        mediaRecorder.start();
        isRecording = true;
        recordBtn.textContent = "‚èπ D·ª´ng";
        stopSpeaking();
        statusText.textContent = "üéôÔ∏è ƒêang ghi √¢m...";
      } catch (err) {
        alert("Kh√¥ng th·ªÉ truy c·∫≠p micro: " + err);
      }
    }

    function stopRecording() {
      mediaRecorder.stop();
      isRecording = false;
      recordBtn.textContent = "üé§ Ghi √¢m";
      statusText.textContent = "‚è≥ ƒêang x·ª≠ l√Ω...";
    }

    async function sendAudioToBackend() {
      const blob = new Blob(audioChunks, { type: "audio/webm" });
      const formData = new FormData();
      formData.append("audio", blob, "recording.webm");

      try {
        const response = await fetch(`${BACKEND_URL}/speech-to-text`, { method: "POST", body: formData });
        const data = await response.json();
        if (data.text) {
          addMessage("user", data.text);
          const chatResponse = await fetch(`${BACKEND_URL}/chat`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: data.text })
          });
          const chatData = await chatResponse.json();
          const reply = chatData.reply || "‚ùå L·ªói ph·∫£n h·ªìi.";
          addMessage("bot", reply);
          speakText(reply);
        } else addMessage("bot", "‚ùå Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c gi·ªçng n√≥i.");
      } catch (err) {
        addMessage("bot", "‚ö†Ô∏è L·ªói khi x·ª≠ l√Ω √¢m thanh.");
      } finally {
        statusText.textContent = "";
      }
    }

    function speakText(text) {
      if (!window.speechSynthesis) return alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ TTS.");
      stopSpeaking();

      const utterance = new SpeechSynthesisUtterance(text);
      const voices = speechSynthesis.getVoices();
      const selectedVoice = voiceSelect.value;
      utterance.voice = voices.find(v => v.name.includes(selectedVoice)) || voices[0];
      const rateMap = { slow: 0.8, normal: 1, fast: 1.3 };
      utterance.rate = rateMap[speedSelect.value] || 1;

      const emotion = emotionSelect.value;
      if (emotion === "auto") {
        if (text.includes("!")) utterance.pitch = 1.3;
        else if (text.includes("?")) utterance.pitch = 1.1;
        else utterance.pitch = 0.9;
      } else if (emotion === "vui") utterance.pitch = 1.3;
      else if (emotion === "nghi√™m") utterance.pitch = 0.9;
      else utterance.pitch = 1.1;

      utterance.onstart = () => {
        isSpeaking = true;
        speakerIcon.style.display = "inline-block";
        statusText.textContent = "üîä ƒêang n√≥i...";
        if (silenceTimer) clearTimeout(silenceTimer);
      };

      utterance.onend = () => {
        isSpeaking = false;
        speakerIcon.style.display = "none";
        statusText.textContent = "";
        silenceTimer = setTimeout(() => {
          if (!isRecording && !isSpeaking) {
            const prompt = "Anh c√≤n mu·ªën h·ªèi th√™m g√¨ kh√¥ng?";
            addMessage("bot", prompt);
            speakText(prompt);
          }
        }, 6000);
      };

      speechSynthesis.speak(utterance);
    }

    function stopSpeaking() {
      if (window.speechSynthesis.speaking) {
        window.speechSynthesis.cancel();
        isSpeaking = false;
        speakerIcon.style.display = "none";
      }
    }

    window.speechSynthesis.onvoiceschanged = () => {
      const voices = speechSynthesis.getVoices();
      voiceSelect.innerHTML = "";
      voices.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.name;
        opt.textContent = `${v.name} (${v.lang})`;
        voiceSelect.appendChild(opt);
      });
    };
  </script>
</body>
</html>
